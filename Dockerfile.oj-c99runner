FROM docker.io/library/maven@sha256:4ed3e8b6a426af743fffd7e92c43075102966b6a651fe4cab2616a32f4460f01 AS builder
RUN microdnf install -y gcc
WORKDIR /build
COPY ./ ./

RUN mvn package
RUN mkdir -p out
RUN mvn help:evaluate -q -Dexpression=project.version -DforceStdout > out/version
RUN mv oj-c99runner/target/oj-c99runner-$(cat out/version)-jar-with-dependencies.jar out/oj-c99runner.jar

FROM docker.io/library/openjdk@sha256:077ed9ce389738c6fa5b016aa2c9168bfca5398f99a11c34021cd0e9f5894ed3
RUN microdnf install -y gcc && microdnf clean all
COPY --from=builder /build/out /oj-c99runner

RUN useradd -r oj-c99runner
USER oj-c99runner
EXPOSE 1993

ENV RUNNER_ADDRESS 0.0.0.0
ENV RUNNER_PORT 1993

CMD java -jar /oj-c99runner/oj-c99runner.jar
