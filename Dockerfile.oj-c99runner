FROM maven:latest@sha256:8a6fab5e7978123a972eefd4680940b3a86230312a87c48d4982b9e5731106f0 as build
RUN useradd builder
WORKDIR /build
RUN chown builder:builder /build
USER builder
COPY --chown=builder ./ ./

RUN mvn package
RUN mkdir -p out
RUN mvn help:evaluate -q -Dexpression=project.version -DforceStdout > out/version
RUN mv oj-c99runner/target/oj-c99runner-$(cat out/version)-jar-with-dependencies.jar out/oj-c99runner.jar

FROM openjdk:latest@sha256:5f6ced07ffe9349844364b78ddfc80e0632e40d4f5daac1ad7cd3bee9a0357ea
RUN yum install gcc -y && yum clean all
COPY --from=build /build/out /oj-c99runner

RUN useradd -r oj-c99runner
USER oj-c99runner
EXPOSE 1993

ENV RUNNER_ADDRESS 0.0.0.0
ENV RUNNER_PORT 1993

CMD java -jar /oj-c99runner/oj-c99runner.jar
